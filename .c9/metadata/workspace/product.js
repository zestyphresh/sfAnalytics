{"changed":true,"filter":false,"title":"product.js","tooltip":"/product.js","value":"(function(conn, product) {\n    \n    $j = jQuery.noConflict();\n    \n     //PRIVATE VARS\n    var _data = crossfilter();\n            \n    //PUBLIC VARS   \n    var dims = {}, groups = {};\n    var charts = {}, tables = {};\n    var values = {};\n    \n    getData()\n        .then(function(result) { \n            \n            console.log(result);\n            \n            _data.add(result);\n            \n            dims.dummy = _data.dimension(function(d) { return 'all'; });\n            dims.year = _data.dimension(function(d) { return d.FY_Year__c; });\n            \n            //groups.salespersonValue = dims.salesperson.group().reduceSum(function(d) { return d.Value__c.toFixed(0); });\n            //groups.weeklyValue = dims.week.group().reduceSum(function(d) { return d.Value__c.toFixed(0); });\n            groups.yearlySales = dims.year.group().reduce(yearlySalesMatrix.reduceAdd, yearlySalesMatrix.reduceSubract, yearlySalesMatrix.reduceInit);\n            \n            //values.sales = dims.dummy.group().reduceSum(function(d) { return d.Value__c; });\n            //values.volume = dims.dummy.group().reduceSum(function(d) { return d.Quantity__c; });\n\n            //values.totalSales();\n            //values.totalVolumes();\n            //charts.salesperson();\n            //charts.weekly();\n            //tables.product();\n            \n\n        })\n        .done();\n\n    charts.salesperson = function() {\n        \n        var data = _.sortBy(groups.salespersonValue.top(Infinity), function(d) { return d.value; });\n        console.log(data);\n\n        var chart = d4.charts.row()\n            .outerHeight($j('#chart-salesperson').height())\n            .outerWidth($j('#chart-salesperson').width())\n            .margin({ top: 10, right: 50, bottom: 20, left: 140 })\n            .x(function(x){\n                x.key('value');\n            })\n            .y(function(y){\n                y.key('key');\n            })\n            .valueKey('value')\n            .mixout(['xAxis'])\n            .using('barLabels', function(labels) {\n                labels.text(function(d) {\n                    return accounting.formatMoney(d.value, \"£\", 0, \",\", \".\")\n                })\n            })\n        ;\n\n        d3.select('#chart-salesperson')\n            .datum(data)\n            .call(chart)\n        ;\n\n    };\n    \n    charts.weekly = function() {\n        \n        var data = _.sortBy(groups.weeklyValue.orderNatural().top(Infinity), function(d) { return d.key.toDate(); });\n        \n        \n        _.each(data, function(d) { d.key = d.key.format('MMM DD'); });\n        \n        console.log(data);\n\n        //var minDate = moment(_.min(data, 'key').key).subtract(7, 'days').toDate();\n        //var maxDate = moment(_.max(data, 'key').key).add(7, 'days').toDate();\n        \n        var chart = d4.charts.column()\n            .outerHeight($j('#chart-weekly').height())\n            .outerWidth($j('#chart-weekly').width())\n            .margin({ top: 10, right: 10, bottom: 20, left: 20 })\n            .x(function(x){\n                //x.scale('time');\n                //x.min(minDate);\n                //x.max(maxDate)\n                x.key('key');\n            })\n            .y(function(y){\n                y.key('value');\n            })\n            .valueKey('value')\n            //.using('yAxis', function(axis) {\n            //    axis.ticks(d3.time.weeks, 1); \n            //})\n            .mixout('yAxis')\n            .using('barLabels', function(labels) {\n                labels.text(function(d) {\n                    return accounting.formatMoney(d.value, \"£\", 0, \",\", \".\")\n                })\n            })\n        ;\n        \n        var datum = [{ key: 'sales', values: data }]\n        \n        d3.select('#chart-weekly')\n            .datum(data)\n            .call(chart)\n        ;\n           \n    };\n    \n    tables.product = function() {\n        \n        var data = _.sortBy(groups.productMatrix.top(Infinity), function(d) { return d.value.total; });\n        console.log(data);\n      \n        var _columns = [{\"data\": \"key\", \"title\": \"Product\"},\n                        {\"data\": \"value.total\", \"title\": \"Total\"},\n                        {\"data\": \"value.SteveGent\", \"title\": \"SG\"},\n                        {\"data\": \"value.MarkPugh\", \"title\": \"MP\"}, \n                        {\"data\": \"value.BrianMurphy\", \"title\": \"BM\"},                \n                        {\"data\": \"value.StevenHooper\", \"title\": \"SH\"},                    \n                        {\"data\": \"value.TracyBoorman\", \"title\": \"TB\"},                \n                        {\"data\": \"value.PhilLacy\", \"title\": \"PL\"},                      \n                        {\"data\": \"value.BrianRobertson\", \"title\": \"BR\"},        \n                        {\"data\": \"value.NorrieCurrie\", \"title\": \"NC\"},\n                        {\"data\": \"value.MatthewKettleborough\", \"title\": \"MK\"}\n        ];\n\n        var table = $j('#table-matrix').dataTable({\n            'data' : data,\n            'paging' : true,\n            'order': [[ 1, 'desc' ]],\n            'dom' : 'ftip',\n            'columns' : _columns,\n            'columnDefs' : [\n                { \"width\": \"40%\", \"targets\": 0 }\n            ]\n        });\n        \n    };\n\n    var yearlySalesMatrix = {\n        \n        reduceAdd : function (p, v) {\n\n            p.count++;\n            p.ytdQty += p.FY_Year_To_Date__c ? v.Quantity__c : 0;\n            p.ytdVal += p.FY_Year_To_Date__c ? v.Value__c : 0;\n            p.fullQty += v.Quantity__c;\n            p.fullVal += v.Value__c;\n            return p;\n                \n        },\n        \n        reduceSubtract : function (p, v) {\n                \n            p.count--;\n            p.ytdQty -= p.FY_Year_To_Date__c ? v.Quantity__c : 0;\n            p.ytdVal -= p.FY_Year_To_Date__c ? v.Value__c : 0;\n            p.fullQty -= v.Quantity__c;\n            p.fullVal -= v.Value__c;\n            return p;\n                \n        },\n            \n        reduceInit : function () {\n            return { count : 0, ytdVal : 0, ytdQty : 0, fullVal : 0, fullQty : 0};\n        }\n        \n    };   \n        \n    function getData() {\n\n        var deferred = Q.defer();\n        \n        var records = [];\n\n        conn.sobject(\"Daily_Historical_Sales__c\")\n            .select(\"Account__r.Name, FY_Is_Year_To_Date__c, FY_Year__c, FY_Month_Num__c, Quantity__c, Value__c\")\n            .where(\"Product2.Id = \" + \"'\" + product + \"'\")\n            .on('record', function(record) {\n                records.push(record);\n            })\n            .on('error', function(query) {\n                deferred.reject('error');\n            })\n            .on('end', function(err) {\n                deferred.resolve(records);\n            })\n            .run({ autoFetch : true, maxFetch : 10000 });\n\n        return deferred.promise;\n\n    }\n\n})(conn, product);\n","undoManager":{"mark":99,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":170,"column":26},"end":{"row":170,"column":27},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":27},"end":{"row":170,"column":28},"action":"insert","lines":["F"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":28},"end":{"row":170,"column":29},"action":"insert","lines":["Y"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":29},"end":{"row":170,"column":30},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":30},"end":{"row":170,"column":31},"action":"insert","lines":["Y"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":31},"end":{"row":170,"column":32},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":32},"end":{"row":170,"column":33},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":33},"end":{"row":170,"column":34},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":33},"end":{"row":170,"column":34},"action":"remove","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":32},"end":{"row":170,"column":33},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":31},"end":{"row":170,"column":32},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":30},"end":{"row":170,"column":31},"action":"remove","lines":["Y"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":29},"end":{"row":170,"column":30},"action":"remove","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":28},"end":{"row":170,"column":29},"action":"remove","lines":["Y"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":27},"end":{"row":170,"column":28},"action":"remove","lines":["F"]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":26},"end":{"row":170,"column":27},"action":"remove","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":170,"column":25},"end":{"row":170,"column":26},"action":"remove","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":171,"column":27},"end":{"row":171,"column":35},"action":"remove","lines":["Quantity"]},{"start":{"row":171,"column":27},"end":{"row":171,"column":28},"action":"insert","lines":["V"]}]}],[{"group":"doc","deltas":[{"start":{"row":171,"column":28},"end":{"row":171,"column":29},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":171,"column":29},"end":{"row":171,"column":30},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":171,"column":30},"end":{"row":171,"column":31},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":171,"column":31},"end":{"row":171,"column":32},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":178,"column":0},"end":{"row":181,"column":21},"action":"remove","lines":["            p.count--;","            p.total -= v.Quantity__c;","            p[v.Salesperson__r.Name.replace(/\\s/g, \"\")] -= v.Quantity__c;","            return p;"]},{"start":{"row":178,"column":0},"end":{"row":183,"column":21},"action":"insert","lines":["            p.count++;","            p.ytdQty += p.FY_Year_To_Date__c ? v.Quantity__c : 0;","            p.ytdVal += p.FY_Year_To_Date__c ? v.Value__c : 0;","            p.fullQty += v.Quantity__c;","            p.fullVal += v.Value__c;","            return p;"]}]}],[{"group":"doc","deltas":[{"start":{"row":178,"column":19},"end":{"row":178,"column":20},"action":"remove","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":178,"column":19},"end":{"row":178,"column":20},"action":"remove","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":178,"column":19},"end":{"row":178,"column":20},"action":"insert","lines":["-"]}]}],[{"group":"doc","deltas":[{"start":{"row":178,"column":20},"end":{"row":178,"column":21},"action":"insert","lines":["-"]}]}],[{"group":"doc","deltas":[{"start":{"row":179,"column":21},"end":{"row":179,"column":22},"action":"remove","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":179,"column":21},"end":{"row":179,"column":22},"action":"insert","lines":["-"]}]}],[{"group":"doc","deltas":[{"start":{"row":180,"column":21},"end":{"row":180,"column":22},"action":"remove","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":180,"column":21},"end":{"row":180,"column":22},"action":"insert","lines":["-"]}]}],[{"group":"doc","deltas":[{"start":{"row":181,"column":22},"end":{"row":181,"column":23},"action":"remove","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":181,"column":22},"end":{"row":181,"column":23},"action":"insert","lines":["-"]}]}],[{"group":"doc","deltas":[{"start":{"row":182,"column":22},"end":{"row":182,"column":23},"action":"remove","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":182,"column":22},"end":{"row":182,"column":23},"action":"insert","lines":["-"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":20},"end":{"row":201,"column":32},"action":"remove","lines":["Promotion__r"]},{"start":{"row":201,"column":20},"end":{"row":201,"column":21},"action":"insert","lines":["P"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":21},"end":{"row":201,"column":22},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":22},"end":{"row":201,"column":23},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":23},"end":{"row":201,"column":24},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":24},"end":{"row":201,"column":25},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":25},"end":{"row":201,"column":26},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":26},"end":{"row":201,"column":27},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":27},"end":{"row":201,"column":28},"action":"insert","lines":["2"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":44},"end":{"row":201,"column":49},"action":"remove","lines":["promo"]},{"start":{"row":201,"column":44},"end":{"row":201,"column":45},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":45},"end":{"row":201,"column":46},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":46},"end":{"row":201,"column":47},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":47},"end":{"row":201,"column":48},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":48},"end":{"row":201,"column":49},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":49},"end":{"row":201,"column":50},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":201,"column":50},"end":{"row":201,"column":51},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":36,"column":0},"end":{"row":53,"column":6},"action":"remove","lines":["        ","    values.totalSales = function() {","        ","        var data = dims.dummy.group().reduceSum(function(d) { return d.Value__c; }).top(1)[0];","        console.log(data);","        ","        $j('#headline-value').text(accounting.formatMoney(data.value, \"£\", 0, \",\", \".\"));","        ","    };","    ","    values.totalVolumes = function() {","        ","        var data = dims.dummy.group().reduceSum(function(d) { return d.Quantity__c; }).top(1)[0];","        console.log(data);","        ","        $j('#headline-volume').text(accounting.formatNumber(data.value, 0, \",\", \".\"));","        ","    };"]}]}],[{"group":"doc","deltas":[{"start":{"row":36,"column":0},"end":{"row":37,"column":8},"action":"remove","lines":["","        "]}]}],[{"group":"doc","deltas":[{"start":{"row":24,"column":12},"end":{"row":24,"column":13},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":24,"column":13},"end":{"row":24,"column":14},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":12},"end":{"row":25,"column":13},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":13},"end":{"row":25,"column":14},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":58},"end":{"row":22,"column":65},"action":"remove","lines":["product"]},{"start":{"row":22,"column":58},"end":{"row":22,"column":59},"action":"insert","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":59},"end":{"row":22,"column":60},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":60},"end":{"row":22,"column":61},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":61},"end":{"row":22,"column":62},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":62},"end":{"row":22,"column":63},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":63},"end":{"row":22,"column":64},"action":"insert","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":64},"end":{"row":22,"column":65},"action":"insert","lines":["S"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":65},"end":{"row":22,"column":66},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":66},"end":{"row":22,"column":67},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":67},"end":{"row":22,"column":68},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":68},"end":{"row":22,"column":69},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":87},"end":{"row":22,"column":94},"action":"remove","lines":["product"]},{"start":{"row":22,"column":87},"end":{"row":22,"column":98},"action":"insert","lines":["yearlySales"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":120},"end":{"row":22,"column":127},"action":"remove","lines":["product"]},{"start":{"row":22,"column":120},"end":{"row":22,"column":131},"action":"insert","lines":["yearlySales"]}]}],[{"group":"doc","deltas":[{"start":{"row":27,"column":12},"end":{"row":27,"column":13},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":27,"column":13},"end":{"row":27,"column":14},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":12},"end":{"row":28,"column":13},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":13},"end":{"row":28,"column":14},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":12},"end":{"row":31,"column":13},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":13},"end":{"row":31,"column":14},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":30,"column":12},"end":{"row":30,"column":13},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":30,"column":13},"end":{"row":30,"column":14},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":29,"column":12},"end":{"row":29,"column":13},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":29,"column":13},"end":{"row":29,"column":14},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":13,"column":33},"end":{"row":14,"column":0},"action":"insert","lines":["",""]},{"start":{"row":14,"column":0},"end":{"row":14,"column":12},"action":"insert","lines":["            "]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":12},"end":{"row":15,"column":0},"action":"insert","lines":["",""]},{"start":{"row":15,"column":0},"end":{"row":15,"column":12},"action":"insert","lines":["            "]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":12},"end":{"row":15,"column":13},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":13},"end":{"row":15,"column":14},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":14},"end":{"row":15,"column":15},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":15},"end":{"row":15,"column":16},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":16},"end":{"row":15,"column":17},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":17},"end":{"row":15,"column":18},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":18},"end":{"row":15,"column":19},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":19},"end":{"row":15,"column":20},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":20},"end":{"row":15,"column":21},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":21},"end":{"row":15,"column":22},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":22},"end":{"row":15,"column":23},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":23},"end":{"row":15,"column":25},"action":"insert","lines":["()"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":24},"end":{"row":15,"column":25},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":25},"end":{"row":15,"column":26},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":26},"end":{"row":15,"column":27},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":27},"end":{"row":15,"column":28},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":28},"end":{"row":15,"column":29},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":29},"end":{"row":15,"column":30},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":31},"end":{"row":15,"column":32},"action":"insert","lines":[";"]}]}],[{"group":"doc","deltas":[{"start":{"row":184,"column":38},"end":{"row":184,"column":56},"action":"remove","lines":["FY_Year_To_Date__c"]},{"start":{"row":184,"column":38},"end":{"row":184,"column":59},"action":"insert","lines":["FY_Is_Year_To_Date__c"]}]}]]},"ace":{"folds":[],"scrolltop":2220,"scrollleft":69.978125,"selection":{"start":{"row":188,"column":14},"end":{"row":188,"column":14},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":157,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1422186689345}
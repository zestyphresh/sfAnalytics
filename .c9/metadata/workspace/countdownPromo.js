{"changed":true,"filter":false,"title":"countdownPromo.js","tooltip":"/countdownPromo.js","value":"(function(conn, promo) {\n    \n    $j = jQuery.noConflict();\n    \n     //PRIVATE VARS\n    var _data = crossfilter();\n            \n    //PUBLIC VARS   \n    var dims = {}, groups = {};\n    var charts = {}, tables = {};\n    var values = {};\n    \n    getData()\n        .then(function(result) { \n            \n            _data.add(result);\n            \n            dims.dummy = _data.dimension(function(d) { return 'all'; });\n            dims.salesperson = _data.dimension(function(d) { return d.Salesperson__r.Name; });\n            dims.week = _data.dimension(function(d) { return moment(d.Invoice_Date__c).startOf('week'); });\n            dims.product = _data.dimension(function(d) { return d.Product__r.Product_Code_Name__c; });\n            \n            groups.salespersonValue = dims.salesperson.group().reduceSum(function(d) { return d.Value__c.toFixed(0); });\n            groups.weeklyValue = dims.week.group().reduceSum(function(d) { return d.Value__c.toFixed(0); });\n            groups.productMatrix = dims.product.group().reduce(productMatrix.reduceAdd, productMatrix.reduceSubract, productMatrix.reduceInit);\n            \n            values.sales = dims.dummy.group().reduceSum(function(d) { return d.Value__c; });\n            values.volume = dims.dummy.group().reduceSum(function(d) { return d.Quantity__c; });\n\n            values.totalSales();\n            values.totalVolumes();\n            charts.salesperson();\n            charts.weekly();\n            tables.product();\n            \n\n        })\n        .done();\n        \n    values.totalSales = function() {\n        \n        var data = dims.dummy.group().reduceSum(function(d) { return d.Value__c; }).top(1)[0];\n        console.log(data);\n        \n        $j('#headline-value').text(accounting.formatMoney(data.value, \"£\", 0, \",\", \".\"));\n        \n    };\n    \n    values.totalVolumes = function() {\n        \n        var data = dims.dummy.group().reduceSum(function(d) { return d.Quantity__c; }).top(1)[0];\n        console.log(data);\n        \n        $j('#headline-volume').text(accounting.formatNumber(data.value, 0, \",\", \".\"));\n        \n    };\n        \n    charts.salesperson = function() {\n        \n        var data = _.sortBy(groups.salespersonValue.top(Infinity), function(d) { return d.value; });\n        console.log(data);\n\n        var chart = d4.charts.row()\n            .outerHeight($j('#chart-salesperson').height())\n            .outerWidth($j('#chart-salesperson').width())\n            .margin({ top: 10, right: 50, bottom: 20, left: 140 })\n            .x(function(x){\n                x.key('value');\n            })\n            .y(function(y){\n                y.key('key');\n            })\n            .valueKey('value')\n            .mixout(['xAxis'])\n            .using('barLabels', function(labels) {\n                labels.text(function(d) {\n                    return accounting.formatMoney(d.value, \"£\", 0, \",\", \".\")\n                })\n            })\n        ;\n\n        d3.select('#chart-salesperson')\n            .datum(data)\n            .call(chart)\n        ;\n\n    };\n    \n    charts.weekly = function() {\n        \n        var data = _.sortBy(groups.weeklyValue.orderNatural().top(Infinity), function(d) { return d.key.toDate(); });\n        \n        \n        _.each(data, function(d) { d.key = d.key.format('MMM DD'); });\n        \n        console.log(data);\n\n        //var minDate = moment(_.min(data, 'key').key).subtract(7, 'days').toDate();\n        //var maxDate = moment(_.max(data, 'key').key).add(7, 'days').toDate();\n        \n        var chart = d4.charts.column()\n            .outerHeight($j('#chart-weekly').height())\n            .outerWidth($j('#chart-weekly').width())\n            .margin({ top: 10, right: 10, bottom: 20, left: 20 })\n            .x(function(x){\n                //x.scale('time');\n                //x.min(minDate);\n                //x.max(maxDate)\n                x.key('key');\n            })\n            .y(function(y){\n                y.key('value');\n            })\n            .valueKey('value')\n            //.using('yAxis', function(axis) {\n            //    axis.ticks(d3.time.weeks, 1); \n            //})\n            .mixout('yAxis')\n            .using('barLabels', function(labels) {\n                labels.text(function(d) {\n                    return accounting.formatMoney(d.value, \"£\", 0, \",\", \".\")\n                })\n            })\n        ;\n        \n        var datum = [{ key: 'sales', values: data }]\n        \n        d3.select('#chart-weekly')\n            .datum(data)\n            .call(chart)\n        ;\n           \n    };\n    \n    tables.product = function() {\n        \n        var data = _.sortBy(groups.productMatrix.top(Infinity), function(d) { return d.value.total; });\n        console.log(data);\n      \n        var _columns = [{\"data\": \"key\", \"title\": \"Product\"},\n                        {\"data\": \"value.total\", \"title\": \"Total\"},\n                        {\"data\": \"value.SteveGent\", \"title\": \"SG\"},\n                        {\"data\": \"value.MarkPugh\", \"title\": \"MP\"}, \n                        {\"data\": \"value.BrianMurphy\", \"title\": \"BM\"},                \n                        {\"data\": \"value.StevenHooper\", \"title\": \"SH\"},                    \n                        {\"data\": \"value.TracyBoorman\", \"title\": \"TB\"},                \n                        {\"data\": \"value.PhilLacy\", \"title\": \"PL\"},                      \n                        {\"data\": \"value.BrianRobertson\", \"title\": \"BR\"},        \n                        {\"data\": \"value.NorrieCurrie\", \"title\": \"NC\"},\n                        {\"data\": \"value.MatthewKettleborough\", \"title\": \"MK\"}\n        ];\n        \n\n\n        var table = $j('#table-matrix').dataTable({\n            'data' : data,\n            'paging' : true,\n            'order': [[ 1, 'desc' ]],\n            'dom' : 'ftip',\n            'columns' : _columns,\n            'columnDefs' : [\n                { \"width\": \"40%\", \"targets\": 0 }\n            ]\n        });\n        \n    };\n\n    var productMatrix = {\n        \n        reduceAdd : function (p, v) {\n\n            p.count++;\n            p.total += v.Quantity__c;\n            p[v.Salesperson__r.Name.replace(/\\s/g, \"\")] += v.Quantity__c;\n            return p;\n                \n        },\n        \n        reduceSubtract : function (p, v) {\n                \n            p.count--;\n            p.total -= v.Quantity__c;\n            p[v.Salesperson__r.Name.replace(/\\s/g, \"\")] -= v.Quantity__c;\n            return p;\n                \n        },\n            \n        reduceInit : function () {\n            return {'count' : 0, 'total' : 0, 'SteveGent' : 0, 'MarkPugh' : 0, 'BrianMurphy': 0, 'StevenHooper': 0, 'TracyBoorman': 0, \n                    'PhilLacy' : 0, 'BrianRobertson': 0, 'NorrieCurrie': 0, 'MatthewKettleborough': 0};\n        }\n    };   \n        \n    function getData() {\n\n        var deferred = Q.defer();\n        \n        var records = [];\n\n        conn.sobject(\"Daily_Historical_Sales__c\")\n            .select(\"Salesperson__r.Name, Account__r.Name, Quantity__c, Value__c, Invoice_Date__c, Product__r.Product_Code_Name__c\")\n            .where(\"Promotion__r.Id = \" + \"'\" + promo + \"'\")\n            .on('record', function(record) {\n                records.push(record);\n            })\n            .on('error', function(query) {\n                deferred.reject('error');\n            })\n            .on('end', function(err) {\n                deferred.resolve(records);\n            })\n            .run({ autoFetch : true, maxFetch : 10000 });\n\n        return deferred.promise;\n\n    }\n\n})(conn, promo);\n","undoManager":{"mark":28,"position":29,"stack":[[{"group":"doc","deltas":[{"start":{"row":150,"column":10},"end":{"row":151,"column":0},"action":"insert","lines":["",""]},{"start":{"row":151,"column":0},"end":{"row":151,"column":8},"action":"insert","lines":["        "]}]}],[{"group":"doc","deltas":[{"start":{"row":151,"column":8},"end":{"row":152,"column":0},"action":"insert","lines":["",""]},{"start":{"row":152,"column":0},"end":{"row":152,"column":8},"action":"insert","lines":["        "]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":8},"end":{"row":152,"column":9},"action":"insert","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":9},"end":{"row":152,"column":10},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":10},"end":{"row":152,"column":11},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":11},"end":{"row":152,"column":12},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":12},"end":{"row":152,"column":13},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":13},"end":{"row":152,"column":14},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":14},"end":{"row":152,"column":15},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":15},"end":{"row":152,"column":16},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":16},"end":{"row":152,"column":17},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":17},"end":{"row":152,"column":18},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":18},"end":{"row":152,"column":19},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":19},"end":{"row":152,"column":20},"action":"insert","lines":["D"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":20},"end":{"row":152,"column":21},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":21},"end":{"row":152,"column":22},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":22},"end":{"row":152,"column":23},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":23},"end":{"row":152,"column":24},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":24},"end":{"row":152,"column":25},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":25},"end":{"row":152,"column":26},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":26},"end":{"row":164,"column":30},"action":"insert","lines":["'columnDefs' : [{ ","                                'targets' : [0], ","                                'render' : function ( data, type, row, meta ) {","                                    switch (type) {","                                        case 'sort':","                                            return _.indexOf(_stages, data);","                                            break;","                                    }","","                                    return data;","                                },","                                'className' : 'text-right'","                            },"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":26},"end":{"row":152,"column":41},"action":"remove","lines":["'columnDefs' : "]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":29},"end":{"row":153,"column":32},"action":"remove","lines":["","                                "]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":28},"end":{"row":152,"column":29},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":28},"end":{"row":152,"column":32},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":45},"end":{"row":152,"column":46},"action":"remove","lines":["0"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":45},"end":{"row":152,"column":46},"action":"insert","lines":["1"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":46},"end":{"row":152,"column":47},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":47},"end":{"row":152,"column":48},"action":"insert","lines":["3"]}]}],[{"group":"doc","deltas":[{"start":{"row":152,"column":0},"end":{"row":163,"column":30},"action":"remove","lines":["        var _columnDefs = [{    'targets' : [1,3], ","                                'render' : function ( data, type, row, meta ) {","                                    switch (type) {","                                        case 'sort':","                                            return _.indexOf(_stages, data);","                                            break;","                                    }","","                                    return data;","                                },","                                'className' : 'text-right'","                            },"]}]}]]},"ace":{"folds":[],"scrolltop":1800,"scrollleft":0,"selection":{"start":{"row":152,"column":0},"end":{"row":152,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":127,"state":"no_regex","mode":"ace/mode/javascript"}},"timestamp":1422304931817}